#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/twai.h"
#include <inttypes.h>
#include "esp_err.h"

void app_main(void) {
    printf("ESP32 CAN Transmit (Normal Mode)\n");

    // ===== 1. CAN Configuration =====
    twai_general_config_t g_config = TWAI_GENERAL_CONFIG_DEFAULT(
        GPIO_NUM_21,   // TX pin (connect to transceiver's TX input)
        GPIO_NUM_22,   // RX pin (connect to transceiver's RX output)
        TWAI_MODE_NORMAL  // Normal mode (not loopback)
    );
    twai_timing_config_t t_config = TWAI_TIMING_CONFIG_500KBITS();  // 500kbps
    twai_filter_config_t f_config = TWAI_FILTER_CONFIG_ACCEPT_ALL(); // Accept all messages

    // ===== 2. Install & Start CAN Driver =====
    esp_err_t err;
    
    // Install driver
    err = twai_driver_install(&g_config, &t_config, &f_config);
    if (err != ESP_OK) {
        printf("CAN driver install failed: %s\n", esp_err_to_name(err));
        return;
    }
    printf("CAN driver installed\n");

    // Start driver
    err = twai_start();
    if (err != ESP_OK) {
        printf("CAN driver start failed: %s\n", esp_err_to_name(err));
        return;
    }
    printf("CAN driver started\n");

    // ===== 3. Prepare CAN Message =====
    twai_message_t message = {
        .identifier = 0x100,  // CAN ID (11-bit)
        .extd = 0,           // Standard frame (not extended)
        .rtr = 0,            // Not a remote frame
        .data_length_code = 4, // 4 bytes of data
        .data = {0x11, 0x22, 0x33, 0x44} // Data payload
    };

    // ===== 4. Transmission Loop =====
    while (1) {
        // Transmit message (timeout = 1000ms)
        err = twai_transmit(&message, pdMS_TO_TICKS(1000));
        
        if (err == ESP_OK) {
            printf("CAN Sent: ID=0x%" PRIX32 " Data=%02X %02X %02X %02X\n",
                   message.identifier,
                   message.data[0], message.data[1],
                   message.data[2], message.data[3]);
        } else {
            printf("TX Failed: %s\n", esp_err_to_name(err));
        }

        // Wait 2 seconds before next transmission
        vTaskDelay(pdMS_TO_TICKS(2000));
    }
}

#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/twai.h"
#include <inttypes.h>
#include "esp_err.h"

void app_main(void) {
    printf("ESP32 CAN Transmit (Normal Mode)\n");

    // ===== 1. CAN Configuration =====
    twai_general_config_t g_config = TWAI_GENERAL_CONFIG_DEFAULT(
        GPIO_NUM_21,   // TX pin (connect to transceiver's TX input)
        GPIO_NUM_22,   // RX pin (connect to transceiver's RX output)
        TWAI_MODE_NORMAL  // Normal mode (not loopback)
    );
    twai_timing_config_t t_config = TWAI_TIMING_CONFIG_500KBITS();  // 500kbps
    twai_filter_config_t f_config = TWAI_FILTER_CONFIG_ACCEPT_ALL(); // Accept all messages

    // ===== 2. Install & Start CAN Driver =====
    esp_err_t err;
    
    // Install driver
    err = twai_driver_install(&g_config, &t_config, &f_config);
    if (err != ESP_OK) {
        printf("CAN driver install failed: %s\n", esp_err_to_name(err));
        return;
    }
    printf("CAN driver installed\n");

    // Start driver
    err = twai_start();
    if (err != ESP_OK) {
        printf("CAN driver start failed: %s\n", esp_err_to_name(err));
        return;
    }
    printf("CAN driver started\n");

    // ===== 3. Prepare CAN Message =====
    twai_message_t message = {
        .identifier = 0x100,  // CAN ID (11-bit)
        .extd = 0,           // Standard frame (not extended)
        .rtr = 0,            // Not a remote frame
        .data_length_code = 4, // 4 bytes of data
        .data = {0x11, 0x22, 0x33, 0x44} // Data payload
    };

    // ===== 4. Transmission Loop =====
    while (1) {
        // Transmit message (timeout = 1000ms)
        err = twai_transmit(&message, pdMS_TO_TICKS(1000));
        
        if (err == ESP_OK) {
            printf("CAN Sent: ID=0x%" PRIX32 " Data=%02X %02X %02X %02X\n",
                   message.identifier,
                   message.data[0], message.data[1],
                   message.data[2], message.data[3]);
        } else {
            printf("TX Failed: %s\n", esp_err_to_name(err));
        }

        // Wait 2 seconds before next transmission
        vTaskDelay(pdMS_TO_TICKS(2000));
    }
}

